<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NASCAR Live Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 20px;
      text-align: center;
    }
    h1 {
      color: #ffcc00;
    }
    #race-info {
      font-size: 1.2em;
      margin-bottom: 15px;
    }
    table {
      width: 95%;
      margin: 10px auto;
      border-collapse: collapse;
      background: #222;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #333;
    }
    th {
      background: #333;
      color: #ffcc00;
    }
    tr:nth-child(even) {
      background: #1a1a1a;
    }
    .fastest {
      color: #0f0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>NASCAR Live Tracker</h1>
  <div id="race-info">Loading race info...</div>

  <h2>Live Race Feed</h2>
  <table id="race-table">
    <thead>
      <tr>
        <th>Pos</th>
        <th>Car #</th>
        <th>Driver</th>
        <th>Interval</th>
        <th>Status</th>
        <th>Laps Led</th>
        <th>Fastest Lap</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Live Points</h2>
  <table id="points-table">
    <thead>
      <tr>
        <th>Pos</th>
        <th>Driver</th>
        <th>Points</th>
        <th>Behind Leader</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchData() {
      try {
        const [feedRes, pointsRes, raceListRes] = await Promise.all([
          fetch("https://cf.nascar.com/live/feeds/live-feed.json"),
          fetch("https://cf.nascar.com/live/feeds/series_1/5580/live_points.json"),
          fetch("https://cf.nascar.com/cacher/2025/race_list_basic.json")
        ]);

        const feed = await feedRes.json();
        const points = await pointsRes.json();
        const raceList = await raceListRes.json();

        // ----- RACE INFO HEADER -----
        const currentRace = raceList.series_1.find(r => r.race_id === feed.race_id);
        const stageLaps = [
          currentRace?.stage_1_laps || 0,
          currentRace?.stage_2_laps || 0,
          currentRace?.stage_3_laps || 0
        ].filter(l => l > 0);

        const lapsCompleted = feed.lap_number || 0;
        let currentStage = 1;
        let lapTotal = 0;
        for (let i = 0; i < stageLaps.length; i++) {
          lapTotal += stageLaps[i];
          if (lapsCompleted <= lapTotal) {
            currentStage = i + 1;
            break;
          }
        }

        const flagState = {
          1: "Green",
          2: "Yellow",
          3: "Red",
          4: "White",
          8: "Checkered"
        }[feed.flag_state] || "Unknown";

        document.getElementById("race-info").innerText =
          `Flag: ${flagState} | Stage: ${currentStage} of ${stageLaps.length} | Laps: ${lapsCompleted}/${feed.laps_in_race}`;

        // ----- TABLE 1: LIVE RACE FEED -----
        const raceTable = document.querySelector("#race-table tbody");
        raceTable.innerHTML = "";

        // Find the fastest lap in the field
        const fastestLapTime = Math.min(
          ...feed.vehicles
            .map(v => v.best_lap_time)
            .filter(t => t > 0)
        );

        feed.vehicles
          .sort((a, b) => a.running_position - b.running_position)
          .forEach(v => {
            const tr = document.createElement("tr");
            const driverName = v.driver.full_name;
            const hasFastest = v.best_lap_time === fastestLapTime;
            tr.innerHTML = `
              <td>${v.running_position}</td>
              <td>${v.vehicle_number}</td>
              <td>${driverName}</td>
              <td>${v.delta || "-"}</td>
              <td>${v.status === 1 ? "Running" : "Out"}</td>
              <td>${v.laps_led?.length ? v.laps_led[0].end_lap : 0}</td>
              <td class="${hasFastest ? 'fastest' : ''}">${hasFastest ? 'âœ…' : ''}</td>
            `;
            raceTable.appendChild(tr);
          });

        // ----- TABLE 2: LIVE POINTS -----
        const pointsTable = document.querySelector("#points-table tbody");
        pointsTable.innerHTML = "";

        const leaderPoints = points.vehicles?.[0]?.points || 0;
        points.vehicles
          .sort((a, b) => a.points_position - b.points_position)
          .forEach(p => {
            const behind = p.points_position === 1
              ? "-"
              : (leaderPoints - p.points);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.points_position}</td>
              <td>${p.first_name} ${p.last_name}</td>
              <td>${p.points}</td>
              <td>${behind === "-" ? "-" : behind}</td>
            `;
            pointsTable.appendChild(tr);
          });

      } catch (err) {
        console.error("Error fetching data:", err);
        document.getElementById("race-info").innerText = "Error loading data.";
      }
    }

    // Refresh every 10 seconds
    fetchData();
    setInterval(fetchData, 10000);
  </script>
</body>
</html>
